<meta charset="utf-8">
<title>This is Mongo-Blog</title>
<div class="new-post">
	<form name="post" action="/" method="post">
		<input type="text" name="title" placeholder="input title here"/>
		<input type="text" name="body" placeholder="input body here"/>
		<button type="submit">저장</button>
	</form>
</div>
<div class="post-list">$POST
</div>

<script>
var updateButtons = document.querySelectorAll(".update-button");
var deleteButtons = document.querySelectorAll(".delete-button");

for (var i = 0; i < updateButtons.length; i++) {
	var updateButton = updateButtons[i];
	updateButton.addEventListener("click", setUpdateState);
	var deleteButton = deleteButtons[i];
	deleteButton.addEventListener("click", deletePost);
}

function setUpdateState(e) {
	var postDiv = e.target.parentNode;
	var editable = document.createElement("input");
	var editBtn = postDiv.querySelector(".update-button");
	var text = postDiv.querySelector(".post-content").innerText;
	editable.type = "text";
	editable.value = text;
	editable.className = "editting";
	postDiv.insertBefore(editable, editBtn);
	var saveBtn = document.createElement("button");
	saveBtn.innerText = "저장";
	postDiv.insertBefore(saveBtn, editBtn);
	
	saveBtn.addEventListener("click", updatePost);
	
}

function xhr(requestData, method, url, callback){
	var request = new XMLHttpRequest();
	request.open(method, url, true );
	request.onload = function(){
		callback();
	}
	request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded; charset=utf-8");
	request.send(requestData);
}

function updatePost(e) {
	var updateDivId = e.target.parentNode.id;
	
	//완료, 취소 버튼을 놓고, 완료 누를경우
	var updatedTitle = document.querySelector(".post-title").innerText;
	var updatedBody = document.querySelector(".editting").value;
	var requestData = {id: updateDivId, title: updatedTitle, body: updatedBody};
	var reqDataList = [];
	for (obj in requestData) {
		reqDataList.push(obj + "=" + requestData[obj]);
	}
	
	var callback = function(){
		
	};
	xhr(reqDataList.join("&"), "POST", "http://localhost:3000/update", callback);
}

function deletePost(e) {
	var updateDiv = e.target.parentNode;
	console.log("id" + updateDiv.id);
	var callback = function(){
		updateDiv.parentNode.removeChild(updateDiv);
	};
	xhr(null, "DELETE", "http://localhost:3000/?post_id="+updateDiv.id ,callback);
}
</script>